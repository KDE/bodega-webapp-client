extends layout
block head
  title Welcome to the #{network} Web Store
  script
    $(document).ready(function() {
      var sockjs_url = '/indexTakeAssets';
      var sockjs = new SockJS(sockjs_url);
      sockjs.onopen = function() {
        console.log('[*] open', sockjs.protocol);
      }

      sockjs.onmessage = function(e) {
        var result = $.parseJSON(e.data);
        var i = 0;
        $.each(result, function(key, value) {
          populateTemplate(value.id, value.name, i%3);
          i = i + 1;
        });

        var template = $('.row-fluid.show-grid#separator-thumbnail');
        template.hide();
      }

      sockjs.onclose = function() {
        console.log('[*] close');
      }

      $('.dropdown-toggle').click(function(event) {
        var categoryId = $(this).attr('id');
        var categoryPage = 1;
        sockjs.send(categoryId, categoryPage);
      });

      $('.dropdown-menu > li a').click(function(event) {
        var subCategoryId = $(this).attr('id');
        var subCategoryPage = 1;
        sockjs.send(subCategoryId, subCategoryPage);
      });

      function populateTemplate(id, name, separator) {
        if (separator == 0) {
          var separatorContent = $('.row-fluid.show-grid#separator-thumbnail').clone().appendTo($('.span10')).end();
          //in order to clone our template we need to remove its id everytime
          //if we don't remove it then we are going to have multiple entries on the webpage
          separatorContent.attr('id', '');
          var thumbnailContent = $('.span4#thumbnail-template:last');
          thumbnailContent.attr('id', id);
          thumbnailContent.children().children('p').text(name);
        } else {
          var content = $('.span4#thumbnail-template:last').clone().appendTo($('.thumbnails:last')).end();
          content.children().children('p').text(name);
          content.attr('id', id);
        }
      }



    });
block body
  .title
    h1(align='center') Welcome to the #{network} Web Store
  .container-fluid
    .row-fluid
      .span2
        ul.nav.nav-tabs.nav-pills.nav-stacked
          for category in categories
            li.dropdown
              a.dropdown-toggle(data-toggle='dropdown', href='#', id='#{category.id}') #{category.name}
                if (category.subcategories.length > 0)
                  b.caret
                  ul.dropdown-menu
                    for subCategory in category.subcategories
                      li
                        a(href="#", id='#{subCategory.id}') #{subCategory.name}
      .span10
        .row-fluid.show-grid(id='separator-thumbnail')
            ul.thumbnails
              li.span4(id='thumbnail-template')
                .thumbnail
                  p Name

